<!DOCTYPE html>
<html>
  <head>
    <meta name="description" content="inchworms RGSoC">
    <meta name="keywords" content="inchworms, rails girls, summer of code, open source, sinatra, farm subsidy">
    <meta name="author" content="inchworms_">
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="alternate" type="application/rss+xml" title="inchworms" href="http://inchworms.net/blog/feed.xml">
    <link rel="shortcut icon" href="/faviconStatic.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="/stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>inch by inch</title>
    <script type="text/javascript" src="/javascripts/d3.v3.js">
    </script>
    <!-- <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?2.1.3"></script> -->
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <a href="/blog" class="">
          <img src="http://25.media.tumblr.com/aab70fec3abd0a9a6b9f1803621aabc0/tumblr_mn2s5hgPpX1qlpk58o1_400.gif" alt="inchworm" height="84" width="100" style="position:relative; top:5px; float:right;">   
          <h1>inchworms</h1></a>
          <h2>Summer of Coding, one inch at a time...</h2>
              
        </header>
   
        <section id="main_content">
                <article class="main_content">
    <h1>The Technique of Shoving</h1>
      <p class='meta'>
        
          <a href='http://twitter.com/inchworms_'>inchworms</a> -
        
        <time datetime="Mon 2 September, 2013">Mon 2 September, 2013</time>
        <span style="float:right">
          <a href="https://twitter.com/share" class="twitter-share-button" data-text="The Technique of Shoving" data-via="inchworms_" data-hashtags="rgsoc" data-count="none">Tweet</a></span>
<script>
!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
        
      </p>
      <p>Today we continued working with our test data, making decisions about what we wanted to show and the data structure we would need to build. Our first objective was to show a bar chart of the top 20 subsidy recipients by year.</p>

<p>First step: retrieve the relevant data and &quot;shove&quot; it into a ruby hash.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">    require &#39;csv&#39;
    require &#39;rubygems&#39;
    require &#39;sequel&#39;
    require &#39;logger&#39;

    # top_payments will be an aray of hashes with the final results
    # eg [{rank: 1, name: &quot;horst&quot;, amount: 234556}, {...}]
    top_payments = []

    # connect to an in-memory database
    DB = Sequel.postgres(&quot;farmsubsidy_performance&quot;, :loggers =&gt; [Logger.new($stdout)])

    #select a year between 2004 and 2011
    p &quot;Select a year between 2004 and 2011:&quot;
    year_selection = gets

    # find the year_id from the years table
    year_id = DB[:years].where(year: year_selection.to_i).first[:id]

    # find payments by year, order them by amount, and return the first 20
    payments_sorted = DB[:payments].where(year_id: year_id).reverse_order(:amount_euro).limit(20)

    # find recipient name, create an index, shove it into top_payments hash
    payments_sorted.each_with_index do |payment, index|
        recipient_name = DB[:recipients].where(id: payment[:recipient_id]).first[:name].gsub(&quot;\&quot;&quot;, &quot;&quot;)
        top_payments &lt;&lt; {rank: index+1, name: recipient_name, amount: payment[:amount_euro]}
    end

    p top_payments
</code></pre></div>
<p>Then, use the hash to create a CSV file.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">    CSV.open(&quot;top_payments.csv&quot;, &quot;w&quot;, :force_quotes =&gt; true) do |csv|
      i = 0
      csv &lt;&lt; [&quot;rank&quot;,&quot;name&quot;,&quot;amount&quot;]
      while i &lt; top_payments.length
        csv &lt;&lt; [top_payments[i][:rank],top_payments[i][:name],top_payments[i][:amount].to_i]
        i += 1
      end
    end
</code></pre></div>
<p>Finally, write some <a href="https://github.com/inchworms/farmsubsidy/blob/master/index.html">d3 code</a> to parse the csv file and display the data like this:</p>

<p><img src="/images/czech_bar.png" alt="horizontal_bar"></p>

<p>It made us feel like this:</p>

<p><img src="/images/dancing.gif" alt="dancing"></p>

      <p><img src="../../images/hr.png" style="50% 0 no-repeat"></p>
    </article>


        </section>

        <footer>
          inchworms is maintained by <a href="https://github.com/carlad">carlad</a> & <a href="https://github.com/tyranja">tyranja</a> as part of their <a href="http://railsgirlssummerofcode.org">Rails Girls Summer of Code</a> team project.<br>
          An <a href="http://inchworms.net/blog/feed.xml">RSS feed</a> is available. You can also follow inchworms on <a href="https://twitter.com/inchworms_">twitter</a>.<br> 
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="http://twitter.com/jasonlong">Jason Long</a>.<br>
        </footer>

                  <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-41825288-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

          <!-- Start of StatCounter Code for Default Guide -->
              <script type="text/javascript">
                var sc_project=9035219; 
                var sc_invisible=1; 
                var sc_security="4db3485e"; 
                var scJsHost = (("https:" == document.location.protocol) ?
                "https://secure." : "http://www.");
                document.write("<sc"+"ript type='text/javascript' src='" +
                scJsHost+
                "statcounter.com/counter/counter.js'></"+"script>");
              </script>
              <noscript>
                <div class="statcounter"><a title="web counter"
                  href="http://statcounter.com/free-hit-counter/"
                  target="_blank"><img class="statcounter"
                  src="http://c.statcounter.com/9035219/0/4db3485e/1/"
                  alt="web counter"></a></div>
            </noscript>
              <!-- End of StatCounter Code for Default Guide -->

      </div>
    </div>
  </body>
</html>
