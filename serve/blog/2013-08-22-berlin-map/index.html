<!DOCTYPE html>
<html>
  <head>
    <meta name="description" content="inchworms RGSoC">
    <meta name="keywords" content="inchworms, rails girls, summer of code, open source, sinatra, farm subsidy">
    <meta name="author" content="inchworms_">
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="alternate" type="application/rss+xml" title="inchworms" href="http://inchworms.net/blog/feed.xml">
    <link rel="shortcut icon" href="/faviconStatic.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="/stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>inch by inch</title>
    <script type="text/javascript" src="/javascripts/d3.v3.js">
    </script>
    <!-- <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?2.1.3"></script> -->
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <a href="/blog" class="">
          <img src="http://25.media.tumblr.com/aab70fec3abd0a9a6b9f1803621aabc0/tumblr_mn2s5hgPpX1qlpk58o1_400.gif" alt="inchworm" height="84" width="100" style="position:relative; top:5px; float:right;">   
          <h1>inchworms</h1></a>
          <h2>Summer of Coding, one inch at a time...</h2>
              
        </header>
   
        <section id="main_content">
                <article class="main_content">
    <h1>Berlin map</h1>
      <p class='meta'>
        
          <a href='http://twitter.com/inchworms_'>inchworms</a> -
        
        <time datetime="Thu 22 August, 2013">Thu 22 August, 2013</time>
        <span style="float:right">
          <a href="https://twitter.com/share" class="twitter-share-button" data-text="Berlin map" data-via="inchworms_" data-hashtags="rgsoc" data-count="none">Tweet</a></span>
<script>
!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
        
      </p>
      <p>There are more than just a programming issue when you want to draw a map with d3. It took literally half a day to find a working Berlin map. </p>

<p><img src="/images/not_working_json.png" alt="berlin" style="width: 600px;"/>
<strong>Not working json</strong>
<p></p>
Then I came across that <a href="https://github.com/m-hoerz/berlin-shapes">github account</a> with a perfectly working map with the districs already in geojson format. Just what I was looking for.</p>

<p><img src="/images/working_json.png" alt="berlin" style="width: 600px;"/>
<strong>working json</strong></p>

<p>Isn&#39;t it gorgeous? And look at the colors!
Anyway then I made a choropleth map out of it and finally (took me half a day and a movie-evening with friend(there were complaing I wasn&#39;t watching)) got bars that are transforming from the BOTTOM to the top like normal bars do and not from the top to bottom. <s>And the number of the population that are supposed to be on every bar is not there, although its on my localhost, argggggg! Just imagine they are there.</s>Resolved. Thanks to Matt!</p>

<div id="geo_mapping_berlin" style="height: 650px;" ></div>

<script type="text/javascript">
(function() {
      var w = 800;
      var h = 650;

        //Create SVG element
      var svg = d3.select("#geo_mapping_berlin")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

      var color = d3.scale.quantize()
                .range(["rgb(255,247,188)","rgb(254,227,145)","rgb(254,196,79)","rgb(254,153,41)","rgb(236,112,20)","rgb(204,76,2)","rgb(153,52,4)","rgb(102,37,6)"]);

      d3.csv("/data/berlin_population.csv", function(data) {

        var yScale = d3.scale.linear()
          .domain([d3.min(data, function(d) { return d.population; }), d3.max(data, function(d) { return d.population; }) ])
          .range([20, h/3.5]);
          // console.log(yScale(2))

        //Set input domain for color scale
        color.domain([
          d3.min(data, function(d) { return d.population; }), 
          d3.max(data, function(d) { return d.population; })
        ]);

        d3.json("/data/berlin.json", function(json) {
          //Merge the ag. data and GeoJSON
          //Loop through once for each ag. data value
          for (var i = 0; i < data.length; i++) {

            //Grab state name
            var dataDistrict = data[i].district;

            //Grab data value, and convert from string to float
            var dataPopulation = parseFloat(data[i].population);
            var dataLat = parseFloat(data[i].lat);
            var dataLon = parseFloat(data[i].lon);
        
            //Find the corresponding state inside the GeoJSON
            for (var j = 0; j < json.features.length; j++) {
              var jsonDistrict = json.features[j].properties.Name;
              if (dataDistrict == jsonDistrict) {
                //Copy the data Population into the JSON
                json.features[j].properties.population = dataPopulation;
                json.features[j].properties.lat = dataLat;
                json.features[j].properties.lon = dataLon;

                //Stop looking through the JSON
                break;
                }
              }
            }

          var center = d3.geo.centroid(json);
          
          //Tooltip div added
          var div_tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

          //Define map projection
          var projection = d3.geo.mercator()
                .center(center)
                .scale([350000])
                .translate([w/2, h/2]);

          //Define path generator
          var path = d3.geo.path()
                   .projection(projection);

          svg.selectAll("path")
            .data(json.features)
            .enter()
            .append("path")
            .attr("d", path)
            .style("stroke", 'white')
            .style("stroke-width", 2)
            .style("fill", function(d) {
              //Get data value
              var population = d.properties.population;
              
              if (population) {
                //If value exists…
                return color(population);
              } else {
                //If value is undefined…
                return "#ccc";
              }
            })
            .on("mouseover", function(d) {
              d3.select(this).style("stroke", "white").style("stroke-width", 5)
              div_tooltip
                .transition()
                .duration(200)
                .style("opacity", .9);
              div_tooltip
                .html("<b>" + d.properties.Name + "</b></br> Population:" + d.properties.population)
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY - 28) + "px");
              number
                .text(d.properties.population)
                .attr("x", function() {
                  return (projection([d.properties.lon, d.properties.lat])[0]) + "px";
                  })
                .attr("y", function() {
                  return (projection([d.properties.lon, d.properties.lat])[1]) + "px";
                  })
              number
                .transition()
                .duration(600)
                .attr("x", function() {
                  return (projection([d.properties.lon, d.properties.lat])[0]) + "px";
                  })
                .attr("y", function() {
                  return (projection([d.properties.lon, d.properties.lat])[1]) - yScale(d.properties.population) - 1 + "px";
                  });
              rectangle
                .attr("x", function() {
                  return (projection([d.properties.lon, d.properties.lat])[0]);
                  })
                .attr("y", function() {
                  return (projection([d.properties.lon, d.properties.lat])[1])
                  });
              rectangle
                .attr("height", 0)
                .transition()
                .duration(600)
                .attr("height", function() {
                  return yScale(d.properties.population);
                  })
                .attr("y", function() {
                  return (projection([d.properties.lon, d.properties.lat])[1]) - yScale(d.properties.population);
                  })
                })
            .on("mouseout", function(d) {
              div_tooltip
                .transition()
                .duration(500)
                .style("opacity", 0);
              d3.select(this)
                .style("stroke", "white")
                .style("stroke-width", 2);
              });

          var rectangle = svg.append("rect")
                .attr("width", 70)
                .style("fill", "#06665D")
                .style("opacity", 0.9);

          var number = d3.select("svg").append("text")
            .attr("class", "number");
          });

        });

      // //Width and height
      // var w = 800;
      // var h = 550;

      // //Create SVG element
      // var svg = d3.select("#geo_mapping_berlin")
      //       .append("svg")
      //       .attr("width", w)
      //       .attr("height", h);

      // var color = d3.scale.quantize()
      //           .range(["rgb(255,247,188)","rgb(254,227,145)","rgb(254,196,79)","rgb(254,153,41)","rgb(236,112,20)","rgb(204,76,2)","rgb(153,52,4)","rgb(102,37,6)"]);

      // d3.csv("/data/berlin_population.csv", function(data) {

      //   var yScale = d3.scale.linear()
      //     .domain([d3.min(data, function(d) { return d.population; }), d3.max(data, function(d) { return d.population; }) ])
      //     .range([20, h/3.5]);
      //     // console.log(yScale(2))

      //   //Set input domain for color scale
      //   color.domain([
      //     d3.min(data, function(d) { return d.population; }), 
      //     d3.max(data, function(d) { return d.population; })
      //   ]);

      //   d3.json("/data/berlin.json", function(json) {
      //     //Merge the ag. data and GeoJSON
      //     //Loop through once for each ag. data value
      //     for (var i = 0; i < data.length; i++) {
        
      //       //Grab state name
      //       var dataDistrict = data[i].district;
            
      //       //Grab data value, and convert from string to float
      //       var dataPopulation = parseFloat(data[i].population);
      //       var dataLat = parseFloat(data[i].lat);
      //       var dataLon = parseFloat(data[i].lon);
        
      //       //Find the corresponding state inside the GeoJSON
      //       for (var j = 0; j < json.features.length; j++) {
            
      //         var jsonDistrict = json.features[j].properties.Name;
        
      //         if (dataDistrict == jsonDistrict) {
            
      //           //Copy the data Population into the JSON
      //           json.features[j].properties.population = dataPopulation;
      //           json.features[j].properties.lat = dataLat;
      //           json.features[j].properties.lon = dataLon;

                
      //           //Stop looking through the JSON
      //           break;
                
      //           }
      //         }
      //       }

      //     var center = d3.geo.centroid(json);
          
      //     //Tooltip div added
      //     var div_tooltip = d3.select("body").append("div")
      //       .attr("class", "tooltip_geomapping")
      //       .style("opacity", 0);



      //     //Define map projection
      //     var projection = d3.geo.mercator()
      //           .center(center)
      //           .scale([350000])
      //           .translate([w/2, h/2]);


      //     //Define path generator
      //     var path = d3.geo.path()
      //              .projection(projection);


      //     svg.selectAll("path")
      //       .data(json.features)
      //       .enter()
      //       .append("path")
      //       .attr("d", path)
      //       .style("stroke", 'white')
      //       .style("stroke-width", 2)
      //       .style("fill", function(d) {
      //         //Get data value
      //         var population = d.properties.population;
              
      //         if (population) {
      //           //If value exists…
      //           return color(population);
      //         } else {
      //           //If value is undefined…
      //           return "#ccc";
      //         }
      //       })
      //       .on("mouseover", function(d) {
      //         d3.select(this).style("stroke", "white").style("stroke-width", 5)
      //         div_tooltip
      //           .transition()
      //           .duration(200)
      //           .style("opacity", .9);
      //         div_tooltip
      //           .html("<strong>" + d.properties.Name + "</strong></br> Population:" + d.properties.population)
      //           .style("left", (d3.event.pageX) + "px")
      //           .style("top", (d3.event.pageY - 28) + "px");
      //         div_number
      //           .text(d.properties.population)
      //           .style("left", function() {
      //             return (projection([d.properties.lon, d.properties.lat])[0]) + "px";
      //             })
      //           .style("top", function() {
      //             return (projection([d.properties.lon, d.properties.lat])[1]) -180 + "px";
      //             })
      //         div_number
      //           .style("top", h)
      //           .transition()
      //           .duration(600)
      //           .style("left", function() {
      //             return (projection([d.properties.lon, d.properties.lat])[0]) + "px";
      //             })
      //           .style("top", function() {
      //             return (projection([d.properties.lon, d.properties.lat])[1]) - yScale(d.properties.population) - 18 + "px";
      //             });
      //         rectangle
      //           .attr("x", function() {
      //             // console.log("x=" + (projection([d.properties.lon, d.properties.lat])[0]))
      //             return (projection([d.properties.lon, d.properties.lat])[0]);
      //             })
      //           .attr("y", function() {
      //             console.log("y vor transition=" + (projection([d.properties.lon, d.properties.lat])[1]))
      //             console.log("y nach transition"+ ((projection([d.properties.lon, d.properties.lat])[1]) - yScale(d.properties.population)))
      //             console.log("yScale oder height =" + yScale(d.properties.population))
      //             return (projection([d.properties.lon, d.properties.lat])[1])
      //             });
      //         rectangle
      //           .attr("height", 0)
      //           .transition()
      //           .duration(600)
      //           .attr("height", function() {
      //             return yScale(d.properties.population);
      //             })
      //           .attr("y", function() {
      //             return (projection([d.properties.lon, d.properties.lat])[1]) - yScale(d.properties.population);
      //             })
      //           })
      //       .on("mouseout", function(d) {
      //         div_tooltip
      //           .transition()
      //           .duration(500)
      //           .style("opacity", 0);
      //         d3.select(this)
      //           .style("stroke", "white")
      //           .style("stroke-width", 2);
      //         });

      //     var rectangle = svg.append("rect")
      //           .attr("width", 70)
      //           .style("fill", "#06665D")
      //           .style("opacity", 0.9);

      //     var div_number = d3.select("svg").append("div")
      //       .attr("class", "number")
      //       .style("fill", "black");
      //     });
      //   });

  })()
</script>

      <p><img src="../../images/hr.png" style="50% 0 no-repeat"></p>
    </article>


        </section>

        <footer>
          inchworms is maintained by <a href="https://github.com/carlad">carlad</a> & <a href="https://github.com/tyranja">tyranja</a> as part of their <a href="http://railsgirlssummerofcode.org">Rails Girls Summer of Code</a> team project.<br>
          An <a href="http://inchworms.net/blog/feed.xml">RSS feed</a> is available. You can also follow inchworms on <a href="https://twitter.com/inchworms_">twitter</a>.<br> 
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="http://twitter.com/jasonlong">Jason Long</a>.<br>
        </footer>

                  <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-41825288-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

          <!-- Start of StatCounter Code for Default Guide -->
              <script type="text/javascript">
                var sc_project=9035219; 
                var sc_invisible=1; 
                var sc_security="4db3485e"; 
                var scJsHost = (("https:" == document.location.protocol) ?
                "https://secure." : "http://www.");
                document.write("<sc"+"ript type='text/javascript' src='" +
                scJsHost+
                "statcounter.com/counter/counter.js'></"+"script>");
              </script>
              <noscript>
                <div class="statcounter"><a title="web counter"
                  href="http://statcounter.com/free-hit-counter/"
                  target="_blank"><img class="statcounter"
                  src="http://c.statcounter.com/9035219/0/4db3485e/1/"
                  alt="web counter"></a></div>
            </noscript>
              <!-- End of StatCounter Code for Default Guide -->

      </div>
    </div>
  </body>
</html>
